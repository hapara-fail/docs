---
title: 'Self-Hosting Guide'
description: 'A complete guide to self-hosting the hapara.fail DNS service using AdGuard Home, Unbound, and Google Cloud.'
---

This guide outlines the modern best practices (late 2024/2025 standards) for self-hosting hapara.fail DNS. It covers setting up AdGuard Home as the frontend and Unbound as the recursive backend resolver.

## Prerequisite: VM Setup

We recommend Google Cloud Platform (GCP) for hosting, taking advantage of their free tier.

1.  **Google Cloud E2-micro Instance**:
    - **Region**: `us-east-1` (or your preferred region)
    - **Disk**: 30GB Standard Persistent Disk
    - **OS**: Debian 12 (Bookworm) or 13 (Trixie) x64
    - **Cost**: Free tier eligible
2.  **Create VM** and reserve a **Static IP address**.

### GCP Firewall Policies

Create the following firewall rules in your VPC network:

1.  **Rule: `allow-dns-traffic`**
    - **Source IP ranges**: `0.0.0.0/0`
    - **Protocols/Ports**: Allow `tcp:53` and `udp:53`
2.  **Rule: `delete-later`** (Temporary for setup)
    - **Source IP ranges**: `[YOUR HOME IP ADDRESS]`
    - **Protocols/Ports**: Allow `tcp:3000` (AdGuard Home initial setup)
3.  **Default Web Rule**: Ensure the `default-allow-http` rule exists allowing `tcp:80`.

### Update VM

SSH into your new VM and clean up unnecessary packages before updating:

```bash
# Remove GCP CLI tools that might cause issues and aren't needed
sudo dpkg --remove --force-all google-cloud-cli google-cloud-cli-anthoscli

# Update system
sudo apt update
sudo apt upgrade -y
```

## Step 1: Install AdGuard Home

Install AdGuard Home using the official script:

```bash
wget --no-verbose -O - https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
```

### Initial Configuration

1.  Navigate to `http://[YOUR_EXTERNAL_IP]:3000` in your browser.
2.  Proceed to **Step 3** of the setup wizard.
    > [!NOTE]
    > If you encounter a `bind: address already in use` error on port 53, running `systemd-resolved`, you may need to disable it:
    >
    > ```bash
    > sudo systemctl stop systemd-resolved
    > sudo systemctl disable systemd-resolved
    > sudo rm -f /etc/resolv.conf && echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
    > ```

### DNS Configuration

Once installed, Configure the **DNS Settings** in AdGuard Home:

- **Upstream DNS servers**: `https://dns.cloudflare.com/dns-query` (Temporary, until Unbound is installed)
- **Mode**: Check **Parallel requests**
- **Fallback DNS servers**: `https://dns.cloudflare.com/dns-query`
- **Rate limit**: `15`
- **Subnet prefix length for IPv4**: `32`
- **DNSSEC**: Check **Enable DNSSEC**
- **IPv6**: Check **Disable resolving of IPv6 addresses**
- **Blocking mode**:
  - **Blocked response TTL**: `86400`
- **Cache configuration**:
  - **Cache size**: `20000000`
  - **Override minimum TTL**: `300`
  - **Override maximum TTL**: `86400`
  - **Optimistic Caching**: Check **Optimistic Caching**

### Blocklists

Go to **Filters** -> **DNS Blocklists**:

1.  Add a custom list:
    - **Name**: `hapara.fail Blocklist`
    - **URL**: `https://raw.githubusercontent.com/hapara-fail/blocklist/main/blocklist.txt`
2.  Add a standard list:
    - **Name**: `HaGeZi Normal`
    - **URL**: `https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/multi.txt`

## Step 2: Set up Unbound (Recursive Resolver)

Unbound acts as the backend recursive resolver, talking directly to root DNS servers for privacy and security.

### Install Unbound

```bash
sudo apt update
sudo apt install unbound -y
```

### Configure Unbound

We need to move Unbound to a non-standard port (5335) to avoid conflict with AdGuard Home, and configure it as a recursive resolver.

1.  Create the configuration file:
    ```bash
    sudo nano /etc/unbound/unbound.conf.d/pi-hole.conf
    ```
2.  Paste the following best-practice configuration:

    ```yaml
    server:
      # If no logfile is specified, syslog is used
      verbosity: 0

      # Port to listen on (AdGuard Home will forward to this port)
      port: 5335

      # Listen on localhost only (security best practice)
      interface: 127.0.0.1
      do-ip4: yes
      do-udp: yes
      do-tcp: yes

      # IPV6 - Disable if your network doesn't actively use IPv6
      do-ip6: no

      # Root Hints: The list of primary root servers
      root-hints: '/var/lib/unbound/root.hints'

      # Privacy & Security Settings
      harden-glue: yes
      harden-dnssec-stripped: yes
      use-caps-for-id: yes
      edns-buffer-size: 1232
      prefetch: yes # Refresh frequently used cache items
      num-threads: 1 # Set to 1 for low-power/VM
      so-rcvbuf: 1m

      # Access Control: Allow localhost to talk to Unbound
      access-control: 127.0.0.0/8 allow

      # Privacy: Hide identity of this server
      hide-identity: yes
      hide-version: yes
    ```

### Set up Root Hints

1.  Download the latest root hints file:
    ```bash
    sudo wget https://www.internic.net/domain/named.root -O /var/lib/unbound/root.hints
    ```
2.  (Recommended) Setup a monthly cron job to update this file:
    ```bash
    sudo crontab -e
    ```
    Add this line to the bottom:
    ```bash
    0 0 1 * * wget -O /var/lib/unbound/root.hints https://www.internic.net/domain/named.root
    ```

### Start and Test Unbound

1.  Restart Unbound:
    ```bash
    sudo service unbound restart
    ```
2.  Test DNS resolution (ask Unbound directly on port 5335):
    ```bash
    dig @127.0.0.1 -p 5335 google.com
    ```
    _Result should show status: `NOERROR` and an IP in the answer section._

## Step 3: Link AdGuard Home to Unbound

Now configuring AdGuard Home to use your local Unbound instance as its upstream.

1.  In AdGuard GUI, go to **Settings** > **DNS Settings**.
2.  **Upstream DNS servers**:
    - Delete all existing servers.
    - Add ONLY: `127.0.0.1:5335`
3.  **Parallel Request**: Select **Parallel requests** (Best stability).
4.  **Bootstrap DNS servers**:
    - `9.9.9.9`
    - `1.1.1.1`
5.  **Private Reverse DNS servers**: Point to your router/DHCP if needed (e.g., `192.168.1.1`).
6.  **DNSSEC**: **Enable**. Unbound validates, but this provides a second check.
7.  Click **Test Upstreams** to verify, then **Apply**.

### Cache Optimization

Since Unbound has a superior "prefetching" cache, we optimizing AdGuard to delegate caching duties.

1.  Go to **DNS Cache Configuration**.
2.  **Cache size**: `4194304` (approx 4MB - small cache for UI snappiness).
3.  **Override minimum TTL**: `0` (Let Unbound decide).
4.  **Override maximum TTL**: `0` (Let Unbound decide).
5.  **Optimistic caching**: **UNCHECK** (Disable). Unbound's prefetching covers this better.

## Step 4: Secure Setup (HTTPS & DoT)

Now we set up encryption (DoH/DoT) for your DNS server.

> [!IMPORTANT]
> Ensure you have an A record pointing from your domain (e.g., `dns.hapara.fail`) to your VM's IP address before proceeding.

### Install Certbot

```bash
sudo apt update
sudo apt install certbot -y
```

### Obtain Certificate

1.  Stop AdGuard Home to free up port 80:
    ```bash
    sudo service AdGuardHome stop
    ```
2.  Request cert:
    ```bash
    sudo certbot certonly --standalone -d dns.hapara.fail
    ```
3.  Start AdGuard Home:
    ```bash
    sudo service AdGuardHome start
    ```

### Configure Encryption in AdGuard

1.  Go to **Settings** > **Encryption Settings**.
2.  **Enable Encryption**: Checked.
3.  **Server Name**: `dns.hapara.fail`
4.  **HTTPS Port**: `443` (DNS-over-HTTPS)
5.  **DNS-over-TLS Port**: `853` (DNS-over-TLS)
6.  **Certificates** (Do NOT paste content, use paths):
    - **Certificate path**: `/etc/letsencrypt/live/dns.hapara.fail/fullchain.pem`
    - **Private key path**: `/etc/letsencrypt/live/dns.hapara.fail/privkey.pem`

### Automate Renewal

Create a hook to restart AdGuard when the cert renews.

1.  Edit hook file:
    ```bash
    sudo nano /etc/letsencrypt/renewal-hooks/post/adguard-restart.sh
    ```
2.  Add content:
    ```bash
    #!/bin/bash
    service AdGuardHome restart
    ```
3.  Make executable:
    ```bash
    sudo chmod +x /etc/letsencrypt/renewal-hooks/post/adguard-restart.sh
    ```

### Finalize Firewall

1.  Delete the `delete-later` temporary rule in GCP.
2.  Create a specific rule `allow-secure-dns`:
    - **Source**: `0.0.0.0/0`
    - **TCP**: `443`, `853`
    - **UDP**: `853`

## Step 5: Protection with Fail2Ban

Protect your web interface from brute-force attacks.

1.  **Install Fail2Ban**:

    ```bash
    sudo apt update
    sudo apt install fail2ban -y
    ```

2.  **Create Filter**:
    File: `/etc/fail2ban/filter.d/adguard-web.conf`

    ```ini
    [Definition]
    failregex = ^.*\[error\] POST .* /control/login: from ip <HOST>: invalid username or password.*$
    ignoreregex =
    ```

3.  **Create Jail**:
    File: `/etc/fail2ban/jail.local`

    ```ini
    [adguard-web]
    enabled  = true
    port     = 80,443,3000,8080
    protocol = tcp
    filter   = adguard-web
    logpath  = /opt/AdGuardHome/AdGuardHome.log
    maxretry = 3
    findtime = 600
    bantime  = 3600
    action   = iptables-allports
    ```

4.  **Start Service**:

    ```bash
    sudo systemctl enable fail2ban
    sudo systemctl start fail2ban
    ```

5.  **Verify**:
    ```bash
    sudo fail2ban-client status adguard-web
    ```
